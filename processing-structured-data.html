<!DOCTYPE HTML><html lang=en class="sidebar-visible no-js light"><head><meta charset=UTF-8><title>Processing structured data - Ruby one-liners cookbook</title><meta content="text/html; charset=utf-8"http-equiv=Content-Type><meta name=description content="Example based guide for text processing with Ruby from the command line"><meta name=viewport content="width=device-width, initial-scale=1"><meta name=theme-color content=#ffffff><link rel=icon href=favicon.svg><link rel="shortcut icon"href=favicon.png><link rel=stylesheet href=css/variables.css><link rel=stylesheet href=css/general.css><link rel=stylesheet href=css/chrome.css><link rel=stylesheet href=FontAwesome/css/font-awesome.css><link rel=stylesheet href=fonts/fonts.css><link rel=stylesheet href=highlight.css><link rel=stylesheet href=tomorrow-night.css><link rel=stylesheet href=ayu-highlight.css><link rel=stylesheet href=style.css><body><script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script><script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script><script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script><script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script><nav id=sidebar class=sidebar aria-label="Table of contents"><div class=sidebar-scrollbox><ol class=chapter><li class="chapter-item expanded affix"><a href=cover.html>Cover</a><li class="chapter-item expanded affix"><a href=buy.html>Buy PDF/EPUB versions</a><li class="chapter-item expanded"><a href=preface.html><strong aria-hidden=true>1.</strong> Preface</a><li class="chapter-item expanded"><a href=one-liner-introduction.html><strong aria-hidden=true>2.</strong> One-liner introduction</a><li class="chapter-item expanded"><a href=line-processing.html><strong aria-hidden=true>3.</strong> Line processing</a><li class="chapter-item expanded"><a href=field-separators.html><strong aria-hidden=true>4.</strong> Field separators</a><li class="chapter-item expanded"><a href=record-separators.html><strong aria-hidden=true>5.</strong> Record separators</a><li class="chapter-item expanded"><a href=multiple-file-input.html><strong aria-hidden=true>6.</strong> Multiple file input</a><li class="chapter-item expanded"><a href=processing-multiple-records.html><strong aria-hidden=true>7.</strong> Processing multiple records</a><li class="chapter-item expanded"><a href=two-file-processing.html><strong aria-hidden=true>8.</strong> Two file processing</a><li class="chapter-item expanded"><a href=dealing-with-duplicates.html><strong aria-hidden=true>9.</strong> Dealing with duplicates</a><li class="chapter-item expanded"><a href=processing-structured-data.html class=active><strong aria-hidden=true>10.</strong> Processing structured data</a><li class="chapter-item expanded"><a href=Exercise_solutions.html><strong aria-hidden=true>11.</strong> Exercise Solutions</a></li><br><hr><li class="chapter-item expanded"><i id=git-repository-button class="fa fa-github"></i><a href=https://github.com/learnbyexample/learn_ruby_oneliners>   Source code</a><li class="chapter-item expanded"><i id=home-button class="fa fa-home"></i><a href=https://learnbyexample.github.io/>   My Blog</a><li class="chapter-item expanded"><i id=book-button class="fa fa-book"></i><a href=https://learnbyexample.github.io/books/>   My Books</a></ol></div><div id=sidebar-resize-handle class=sidebar-resize-handle></div></nav><div id=page-wrapper class=page-wrapper><div class=page><div id=menu-bar-hover-placeholder></div><div id=menu-bar class="menu-bar sticky bordered"><div class=left-buttons><button id=sidebar-toggle class=icon-button type=button title="Toggle Table of Contents"aria-label="Toggle Table of Contents"aria-controls=sidebar><i class="fa fa-bars"></i></button><button id=theme-toggle class=icon-button type=button title="Change theme"aria-label="Change theme"aria-haspopup=true aria-expanded=false aria-controls=theme-list><i class="fa fa-paint-brush"></i></button><ul id=theme-list class=theme-popup aria-label=Themes role=menu><li role=none><button role=menuitem class=theme id=light>Light (default)</button><li role=none><button role=menuitem class=theme id=rust>Rust</button><li role=none><button role=menuitem class=theme id=coal>Coal</button><li role=none><button role=menuitem class=theme id=navy>Navy</button><li role=none><button role=menuitem class=theme id=ayu>Ayu</button></ul><button id=search-toggle class=icon-button type=button title="Search. (Shortkey: s)"aria-label="Toggle Searchbar"aria-expanded=false aria-keyshortcuts=S aria-controls=searchbar><i class="fa fa-search"></i></button></div><h1 class=menu-title>Ruby one-liners cookbook</h1><div class=right-buttons><a href=https://learnbyexample.github.io title=Blog aria-label=Blog> <i id=home-button class="fa fa-home"></i> </a><a href=https://github.com/learnbyexample/learn_ruby_oneliners title="Git repository"aria-label="Git repository"> <i id=git-repository-button class="fa fa-github"></i> </a></div></div><div id=search-wrapper class=hidden><form id=searchbar-outer class=searchbar-outer><input type=search id=searchbar name=searchbar placeholder="Search this book ..."aria-controls=searchresults-outer aria-describedby=searchresults-header></form><div id=searchresults-outer class="searchresults-outer hidden"><div id=searchresults-header class=searchresults-header></div><ul id=searchresults></ul></div></div><script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script><div id=content class=content><main><div class=sidetoc><nav class=pagetoc></nav></div><h1 id=processing-structured-data><a class=header href=#processing-structured-data>Processing structured data</a></h1><p>All the examples in previous chapters dealt with simple text formats separated by newline or some other sequence of characters. Such data could be linearly read and processed. However, formats like <code>json</code>, <code>csv</code>, <code>xml</code> and <code>html</code> have a specific structure that requires a custom parser before they can be made available for further processing. This chapter will give a brief overview of libraries to parse such structured inputs.<h2 id=json><a class=header href=#json>JSON</a></h2><p>The <code>JSON</code> built-in module helps you to process <code>json</code> data by converting it to a Ruby <code>hash</code> object. See <a href=https://ruby-doc.org/stdlib-3.0.0/libdoc/json/rdoc/JSON.html>ruby-doc: JSON</a> for documentation.<p>Here's an example of converting possibly minified <code>json</code> input to a pretty printed output.<pre><code class=language-bash>$ s='{"greeting":"hi","marks":[78,62,93]}'

# ARGF.read is an alternate for -0777 option to slurp entire input
$ echo "$s" | ruby -rjson -e 'ip = JSON.parse(ARGF.read);
                   puts JSON.pretty_generate(ip)'
{
  "greeting": "hi",
  "marks": [
    78,
    62,
    93
  ]
}
</code></pre><p>You can create a shortcut to make it easier for one-liners.<pre><code class=language-bash>$ # check if shortcut is available
$ type rq
bash: type: rq: not found

$ # add this to your ~/.bashrc (or the file you use for aliases/functions)
$ rq() { ruby -rjson -e 'ip = JSON.parse(ARGF.read);'"$@" ; }

$ s='{"greeting":"hi","marks":[78,62,93]}'

$ # get value of given key
$ echo "$s" | rq 'puts ip["greeting"]'
hi
$ # you can even pass options after the code snippet
$ echo "$s" | rq 'print ip["marks"]' -l
[78, 62, 93]

$ # use JSON.pretty_generate(ip) if you need pretty output
$ echo "$s" | rq 'ip["marks"][1] = 100; puts JSON.generate(ip)'
{"greeting":"hi","marks":[78,100,93]}
</code></pre><p>Here's another example.<pre><code class=language-bash>$ cat sample.json
{
    "fruit": "apple",
    "blue": ["toy", "flower", "sand stone"],
    "light blue": ["flower", "sky", "water"],
    "language": {
        "natural": ["english", "hindi", "spanish"],
        "programming": ["python", "kotlin", "ruby"]
    },
    "physics": 84
}

$ # process top-level keys not containing 'e'
$ rq 'ip.each {|k,v| puts "#{k}:#{v}" if !k.match?(/e/)}' sample.json
fruit:apple
physics:84

$ # process keys within 'language' key that contain 't'
$ rq 'ip["language"].each {|k,v| puts "#{k}:#{v}" if k.match?(/t/)}' sample.json
natural:["english", "hindi", "spanish"]
</code></pre><h2 id=csv><a class=header href=#csv>CSV</a></h2><p>The <code>CSV</code> built-in class comes in handy for processing <code>csv</code> files. See <a href=https://ruby-doc.org/stdlib-3.0.0/libdoc/csv/rdoc/CSV.html>ruby-doc: CSV</a> for documentation.<p>Here's a simple example that parses entire input string in one shot.<pre><code class=language-bash>$ s='eagle,"fox,42",bee,frog\n1,2,3,4'

$ printf '%b' "$s" | ruby -rcsv -le 'ip=CSV.new(ARGF.read); print ip.read'
[["eagle", "fox,42", "bee", "frog"], ["1", "2", "3", "4"]]

$ printf '%b' "$s" | ruby -rcsv -e 'ip=CSV.new(ARGF.read); puts ip.read[0][1]'
fox,42
</code></pre><p>Here's an example with newline character inside quoted fields. This example directly uses the input filename instead of passing it as command line argument to the <code>ruby</code> script.<pre><code class=language-bash>$ cat newline.csv
apple,"1
2
3",good
guava,"32
54",nice

$ # this will parse entire input in one shot
$ ruby -rcsv -le 'ip=CSV.read("newline.csv"); print ip'
[["apple", "1\n2\n3", "good"], ["guava", "32\n54", "nice"]]

$ # this is better suited for large inputs
$ ruby -rcsv -e 'CSV.foreach("newline.csv"){ |row|
                 puts row[2] if row[0]=~/pp/ }'
good
</code></pre><p>You can change field separator using the <code>col_sep</code> option.<pre><code class=language-bash>
$ ruby -rcsv -e 'CSV.foreach("marks.txt", :col_sep => "\t"){ |r|
                 puts r * "," if r[0]=="ECE" }'
ECE,Raj,53
ECE,Joel,72
ECE,Om,92
</code></pre><p>The <code>headers</code> option will treat the first row as the header, useful for named field processing.<pre><code class=language-bash>$ ruby -rcsv -e 'CSV.foreach("marks.txt", :headers => true, :col_sep => "\t"){
                 |r| puts r["Name"] }'
Raj
Joel
Moi
Surya
Tia
Om
Amy
</code></pre><p>You can automatically try to convert field value to given data type(s) using the <code>converters</code> option. See <a href=https://ruby-doc.org/stdlib-3.0.0/libdoc/csv/rdoc/CSV.html#class-CSV-label-Field+Converters>ruby-doc: CSV Field Converters</a> for details.<pre><code class=language-bash>$ ruby -rcsv -le 'CSV.foreach("marks.txt", :converters => :integer,
                  :col_sep => "\t"){ print _1 }'
["Dept", "Name", "Marks"]
["ECE", "Raj", 53]
["ECE", "Joel", 72]
["EEE", "Moi", 68]
["CSE", "Surya", 81]
["EEE", "Tia", 59]
["ECE", "Om", 92]
["CSE", "Amy", 67]
</code></pre><h2 id=xml-and-html><a class=header href=#xml-and-html>XML and HTML</a></h2><p><a href=https://nokogiri.org/>nokogiri</a> is a popular third-party library to parse <code>xml</code> and <code>html</code> formats. It also supports working with malformed data.<p>To parse an input, you can either pass the string or pass a filehandle. You can also pass <code>URI</code> filehandle for working with URLs directly.<p>Both XPath and CSS based selections are available. See also <a href=https://www.w3schools.com/xml/xpath_intro.asp>XPath introduction</a> and <a href=https://johnresig.com/blog/xpath-css-selectors/>difference between XPath and CSS Selectors</a>. Here's some examples with <code>xpath</code> methods.<pre><code class=language-bash>$ cat sample.xml
&LTdoc>
    &LTgreeting type="ask">Hi there. How are you?&LT/greeting>
    &LTgreeting type="reply">I am good.&LT/greeting>
    &LTcolor>
        &LTblue>flower&LT/blue>
        &LTblue>sand stone&LT/blue>
        &LTlight-blue>sky&LT/light-blue>
        &LTlight-blue>water&LT/light-blue>
    &LT/color>
&LT/doc>

$ # all results for 'blue' tag
$ # note that ARGF filehandle is passed directly here
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath("//blue")' sample.xml
&LTblue>flower&LT/blue>
&LTblue>sand stone&LT/blue>

$ # selecting based on content of 'blue' tags
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath("//blue").grep(/stone/)' sample.xml
&LTblue>sand stone&LT/blue>

$ # use 'at_xpath' instead of 'xpath' to get only the first result
$ # or use 'ip.xpath("//blue")[0]' to get specific elements
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.at_xpath("//blue")' sample.xml
&LTblue>flower&LT/blue>
</code></pre><p>Here's an example with <code>css</code> methods. Use <code>text</code> method to get the value of the selected tags.<pre><code class=language-bash>$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.css("light-blue").map(&:text)' sample.xml
sky
water

$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.at_css("blue").text' sample.xml
flower
</code></pre><p>Here's an example of matching attributes.<pre><code class=language-bash>$ # you can use //@type if you want all attributes that are named as 'type'
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath("//greeting/@type")' sample.xml
ask
reply

$ # match a specific attribute value
$ # same as: ip.css("greeting[type=\"ask\"]")
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath("//greeting[@type=\"ask\"]").text' sample.xml
Hi there. How are you?
</code></pre><p>Here's an example with <code>html</code> input.<pre><code class=language-bash>$ s='https://learnbyexample.github.io/substitution-with-ripgrep/'
$ url="$s" ruby -rnokogiri -ropen-uri -e 'ip=Nokogiri.XML(URI.open(ENV["url"]));
                 puts ip.css("@href")[5..7]'
https://learnbyexample.github.io
https://learnbyexample.github.io/books
https://learnbyexample.github.io/tags
</code></pre><h2 id=summary><a class=header href=#summary>Summary</a></h2><p>This chapter showed basic examples of processing structured data like <code>json</code>, <code>csv</code>, <code>xml</code> and <code>html</code> using built-in and third-party libraries. As mentioned in the introduction chapter, using <code>ruby</code> one-liners for such tasks helps you avoid learning the syntax and idioms of a custom command line tool. Another advantage is that you have the entire ecosystem of a programming language at disposal once the structured input has been parsed. If performance becomes a concern, then custom cli tools like <a href=https://stedolan.github.io/jq/>jq</a>, <a href=https://github.com/BurntSushi/xsv>xsv</a> and <a href=http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html>xmlstarlet</a> will come in handy.<p>No exercises for this final chapter (author is lazy and doesn't have much experience with these formats). So, I'll leave you with links for further reading and as a source of exercises.<ul><li><a href=https://stackoverflow.com/questions/tagged/ruby+json?tab=Votes>stackoverflow: ruby+json</a><li><a href=https://stackoverflow.com/questions/tagged/ruby+csv?tab=Votes>stackoverflow: ruby+csv</a><li><a href=https://stackoverflow.com/questions/tagged/ruby+xml?tab=Votes>stackoverflow: ruby+xml</a><li><a href=https://mosermichael.github.io/jq-illustrated/dir/content.html>Illustrated jq tutorial</a><li><a href=http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html>xmlstarlet tutorial</a></ul></main><nav class=nav-wrapper aria-label="Page navigation"><a rel=prev href=dealing-with-duplicates.html class="mobile-nav-chapters previous"title="Previous chapter"aria-label="Previous chapter"aria-keyshortcuts=Left> <i class="fa fa-angle-left"></i> </a><a rel=next href=Exercise_solutions.html class="mobile-nav-chapters next"title="Next chapter"aria-label="Next chapter"aria-keyshortcuts=Right> <i class="fa fa-angle-right"></i> </a><div style="clear: both"></div></nav></div></div><nav class=nav-wide-wrapper aria-label="Page navigation"><a rel=prev href=dealing-with-duplicates.html class="nav-chapters previous"title="Previous chapter"aria-label="Previous chapter"aria-keyshortcuts=Left> <i class="fa fa-angle-left"></i> </a><a rel=next href=Exercise_solutions.html class="nav-chapters next"title="Next chapter"aria-label="Next chapter"aria-keyshortcuts=Right> <i class="fa fa-angle-right"></i> </a></nav></div><script>
            window.playground_copyable = true;
        </script><script src=elasticlunr.min.js charset=utf-8></script><script src=mark.min.js charset=utf-8></script><script src=searcher.js charset=utf-8></script><script src=clipboard.min.js charset=utf-8></script><script src=highlight.js charset=utf-8></script><script src=book.js charset=utf-8></script><script src=sidebar.js></script>